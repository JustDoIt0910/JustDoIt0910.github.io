<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="记录一下最近对 TCP 连接建立和拆除的一些新的理解和探究。 两将军问题TCP 的连接建立和拆除都与两将军问题有关，但并不是说连接和拆除都存在两将军问题，比较认同中科大郑烇老师的这篇文章的观点，连接建立过程不存在两将军问题，但连接拆除是存在的。(btw，郑烇老师的计算机网络课真的好，有空一定完整听一遍)。两将军问题是所有尝试在不可靠通信链路上建立可靠连接的协议都绕不开的问题，不只是 TCP。我个人">
<meta property="og:type" content="article">
<meta property="og:title" content="对TCP三次握手和四次挥手的理解和探究">
<meta property="og:url" content="http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/index.html">
<meta property="og:site_name" content="Welcome to ZR&#39;s blog">
<meta property="og:description" content="记录一下最近对 TCP 连接建立和拆除的一些新的理解和探究。 两将军问题TCP 的连接建立和拆除都与两将军问题有关，但并不是说连接和拆除都存在两将军问题，比较认同中科大郑烇老师的这篇文章的观点，连接建立过程不存在两将军问题，但连接拆除是存在的。(btw，郑烇老师的计算机网络课真的好，有空一定完整听一遍)。两将军问题是所有尝试在不可靠通信链路上建立可靠连接的协议都绕不开的问题，不只是 TCP。我个人">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p1.jpg">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p2.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p3.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p4.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p5.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p6.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p7.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p8.jpg">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p9.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p10.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p11.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p12.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p13.png">
<meta property="og:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p14.png">
<meta property="article:published_time" content="2023-10-13T15:29:33.000Z">
<meta property="article:modified_time" content="2023-10-14T18:45:09.042Z">
<meta property="article:author" content="ZR">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p1.jpg">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>对TCP三次握手和四次挥手的理解和探究</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/JustDoIt0910">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/10/27/unordered_set%E5%92%8Cunordered_map%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/10/10/%E5%AF%B9%E4%BA%8E%E8%A1%A5%E7%A0%81%E5%92%8C%E5%8F%8D%E7%A0%81%E6%9C%AC%E8%B4%A8%E7%9A%84%E7%90%86%E8%A7%A3/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&text=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&is_video=false&description=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=对TCP三次握手和四次挥手的理解和探究&body=Check out this article: http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&name=对TCP三次握手和四次挥手的理解和探究&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&t=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">两将军问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B"><span class="toc-number">2.</span> <span class="toc-text">关于连接建立</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%EF%BC%8C%E4%B8%A4%E6%AC%A1%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%A1%8C"><span class="toc-number">2.1.</span> <span class="toc-text">一、为什么需要三次握手，两次为什么不行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E6%89%8B%E5%8A%A8%E6%A8%A1%E6%8B%9F%E4%BB%A5%E5%8F%8A%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">二、三次握手的手动模拟以及异常情况处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E8%83%BD%E5%90%A6%E5%B8%A6%E6%95%B0%E6%8D%AE"><span class="toc-number">2.3.</span> <span class="toc-text">三、三次握手能否带数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81TCP-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E4%B8%A4%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">四、TCP 三次握手是否存在两将军问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%BF%9E%E6%8E%A5%E6%8B%86%E9%99%A4"><span class="toc-number">3.</span> <span class="toc-text">关于连接拆除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E6%89%8B%E5%8A%A8%E6%A8%A1%E6%8B%9F%E4%BB%A5%E5%8F%8A%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">一、四次挥手的手动模拟以及异常情况处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E4%B8%A4%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">二、四次挥手是否存在两将军问题</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        对TCP三次握手和四次挥手的理解和探究
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">ZR</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-10-13T15:29:33.000Z" class="dt-published" itemprop="datePublished">2023-10-13</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/">计算机网络/网络编程</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>记录一下最近对 TCP 连接建立和拆除的一些新的理解和探究。</p>
<h2 id="两将军问题"><a href="#两将军问题" class="headerlink" title="两将军问题"></a>两将军问题</h2><p>TCP 的连接建立和拆除都与两将军问题有关，但并不是说连接和拆除都存在两将军问题，比较认同<a target="_blank" rel="noopener" href="https://space.bilibili.com/410739029/">中科大郑烇老师</a>的这篇<a target="_blank" rel="noopener" href="https://www.bilibili.com/read/cv16604716/">文章</a>的观点，连接建立过程不存在两将军问题，但连接拆除是存在的。(btw，郑烇老师的<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1JV411t7ow/">计算机网络课</a>真的好，有空一定完整听一遍)。两将军问题是所有尝试在不可靠通信链路上建立可靠连接的协议都绕不开的问题，不只是 TCP。<strong>我个人对两将军问题本质的总结是：处于不可靠通信链路两端的通信双方无法通过通信来对某一个事情&#x2F;状态达成共识，因为达成共识总是依赖最后一次确认消息，而最后一次确认消息总可能丢失，所以不存在有限次的确认可以使双方达成共识。但是出现这种问题的前提是，要求双方在达成共识后便不再通信，也就是说，双方的状态不能通过后续的通信修正或回退。</strong>两将军问题详细描述如下(整理自<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pX4y1f7gW/">Martin Kleppmann 分布式系统合集翻译版</a>)：</p>
<ul>
<li><p><strong>背景</strong></p>
<p>两将军 A，B 分别位于山谷两侧，山谷中是敌军。将军 A，B 必须同时进攻才可以获胜，如果只有一方进攻则必败(通信双方需要就进攻时间达成共识)。他们通信的唯一方法是派信使穿过山谷到达另一方，但信使可能被俘导致消息无法送达(通信链路不可靠，消息可能丢失)。</p>
</li>
<li><p><strong>分析</strong></p>
<p>站在将军 A 的角度，他有两种选择：</p>
<ol>
<li>派很多信使，并且自己一定会进攻(因为他假定总有一个能到对面，对方一定能和自己达成共识)。这时将军 B 只要收到消息就可以确定进攻，因为他知道 A 一定会进攻，所以 B 一定是安全的。但 A 是不安全的，因为极限情况下信使全部被俘，A 的假定就不成立了，B 没能和他达成共识。此时 A 会面临独自进攻。况且霰弹打鸟的方式浪费太多网络带宽了。</li>
<li>A 只有收到 B 的回复后才会决定进攻。现在 A 是安全的，但是当 B 发送确认消息后，他陷入了上一步中 A 的困境，B 不能决定进攻，因为他知道 A 只有收到自己的确认才会进攻，但他无法知道 A 有没有收到自己的确认，如果自己单方面决定进攻，有可能导致双方的不一致。所以 B 又依赖 A 的确认。</li>
</ol>
<p>如此死循环，最后发送确认的一方总是担心确认丢失而不敢作出决定，于是共识永远无法达成。</p>
<p>尝试翻译成人话：</p>
<p>A   ———————我知道明天进攻，但我要知道你知道明天进攻———————-》  B</p>
<p>A  《——————–我知道明天进攻，但我要知道你知道我知道明天进攻———————–  B</p>
<p>A   ———————我知道你知道明天进攻，但我要知道你知道我知道你知道明天进攻———————-》  B</p>
<p>……..</p>
</li>
<li><p><strong>解决方案</strong></p>
<p>两将军问题无解，但是有工程解。</p>
<ul>
<li>添加第二层保护机制。因为实际生活中大多数状态是可以回退的，即使暂时处于不一致状态，也可以通过后续的回退来补救，不会像两将军那样后果严重。比如 Martin Kleppmann 视频中举的例子，商店的扣款和发货，即使暂时出现状态不一致(比如扣款了但没发货)，那大不了可以退款不是？</li>
<li>超时重传机制。可以缓解两将军问题，比如 TCP。</li>
</ul>
<p>关于 TCP 的三次握手和四次挥手中是否存在两将军问题下面再分析。</p>
</li>
</ul>
<h2 id="关于连接建立"><a href="#关于连接建立" class="headerlink" title="关于连接建立"></a>关于连接建立</h2><h3 id="一、为什么需要三次握手，两次为什么不行"><a href="#一、为什么需要三次握手，两次为什么不行" class="headerlink" title="一、为什么需要三次握手，两次为什么不行"></a>一、为什么需要三次握手，两次为什么不行</h3><p>首先要明白 TCP 握手握的是啥，我觉得主要有两点：</p>
<p>​	a. 双方对于“连接已建立”这个状态的共识</p>
<p>​	b. 双方对于对方 ISN，窗口大小的共识</p>
<p>a 影响双方对于 TCP 连接资源的分配，操作系统对已建立的 TCP 连接需要分配资源，如果双方关于 a 没有达成共识，比如客户端认为没有处于已连接状态，而服务器单方面认为已经处于连接状态，而为其分配了资源，那么就会造成服务器资源浪费。b 就影响双方能否正确通信了，如果连 ISN 都没达成共识，那我怎么知道我收到的这个包序号在不在合法范围内？那数据包的重排，确认就无从谈起了。</p>
<p>下面假设 A 是主动建立一方，B 是被动一方。其实三次握手拆开看是四次：</p>
<p>​	(1) 第一次 A 发送同步包，告知 B 自己的 ISN 和窗口大小</p>
<p>​	(2.1) 第二次 B 确认 A 的同步，双方就 A 的 ISN 和窗口大小达成共识</p>
<p>​	(2.2) 第三次 B 发送同步包，告知 A 自己的 ISN 和窗口大小</p>
<p>​	(3) 第四次 A 确认 B 的同步，双方就 B 的 ISN 和窗口大小，以及连接建立的状态达成共识</p>
<p>只不过 2.1 和 2.2 可以合并成一个包，于是就成了三次握手(btw，挥手是四次是因为 TCP 支持半关闭，有时第二次和第三次挥手没法合成一个，但有时是可以合成三次的，下面的实验中会看到)。</p>
<p>回到问题，为什么不能是两次，也就是为什么不能省掉最后一次。我觉得有两个角度:</p>
<p>​	(1) 为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。这就是教科书上给出的解释。其实本质就是像上面说的，双方没有对于 a 达成共识。没有第三次握手，B 无从知道 A 有没有收到自己的同步消息，它只能假定对方收到了然后单方面进入连接状态，这很有可能导致不一致(参考两将军问题)。</p>
<p>​	(2) B 无法知道 A 是否已经接收到自己的同步信号，它只能假定 A 知道了自己的 ISN，窗口大小。如果这个同		步信号丢失了，A 和 B 就 B 的 ISN，窗口大小将无法达成一致，对应上面的 b，那还谈什么通信呢。</p>
<h3 id="二、三次握手的手动模拟以及异常情况处理"><a href="#二、三次握手的手动模拟以及异常情况处理" class="headerlink" title="二、三次握手的手动模拟以及异常情况处理"></a>二、三次握手的手动模拟以及异常情况处理</h3><p>​	<strong>(1) 正常三次握手过程模拟</strong></p>
<p>​		正常三次握手时序图：</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p1.jpg" alt="p1"></p>
<p>服务器：VMWare 中 Ubuntu 20.04 启动一个简单的 TCP echo server，监听端口 9999，虚拟机使用 NAT 模式。</p>
<p>客户端： Windows 上使用 scapy 构造握手报文。</p>
<table>
<thead>
<tr>
<th></th>
<th>IP</th>
<th>MAC</th>
</tr>
</thead>
<tbody><tr>
<td>服务器</td>
<td>192.168.40.128</td>
<td>00:0C:29:27:A4:B5</td>
</tr>
<tr>
<td>客户端</td>
<td>192.168.40.1</td>
<td>00-50-56-C0-00-08</td>
</tr>
</tbody></table>
<p>用 wireshark 抓包，过滤双方 TCP 报文和 ARP 报文</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ip.src==192.168.40.1&amp;&amp;ip.dst==192.168.40.128)||(ip.dst==192.168.40.1&amp;&amp;ip.src==192.168.40.128))||arp</span><br></pre></td></tr></table></figure>



<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">dst_ip = <span class="string">&quot;192.168.40.128&quot;</span></span><br><span class="line">dst_port = <span class="number">9999</span></span><br><span class="line">src_port = <span class="number">2222</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 SYN</span></span><br><span class="line">syn = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=RandInt(),flags=<span class="string">&quot;S&quot;</span>)</span><br><span class="line"><span class="comment"># 发送 SYN，接收服务器的 SYN + ACK</span></span><br><span class="line">syn_ack = sr1(syn, verbose=<span class="literal">False</span>)</span><br><span class="line">seq_num = syn_ack[TCP].ack</span><br><span class="line">ack_num = syn_ack[TCP].seq + <span class="number">1</span></span><br><span class="line"><span class="comment"># 发送 ACK</span></span><br><span class="line">ack = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=seq_num,ack=ack_num,flags=<span class="string">&quot;A&quot;</span>)</span><br><span class="line">send(ack)</span><br></pre></td></tr></table></figure>

<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p2.png" alt="p2"></p>
<p>首先是两个 ARP 报文，客户端的 IP 层收到上面传输层交付的 TCP SYN 报文段，在路由表中查询目的 IP 192.168.40.128，发现和自己在同一网段，但是没有对方的 MAC 地址，于是先缓存 SYN 报文，广播 ARP request(注：scapy 貌似会自己维护一个 ARP cache table，而不是使用操作系统的，所以即使操作系统的 ARP 表中有缓存，这一步也可能进行 ARP 询问)，获得对方 MAC 以后，填到 SYN 报文以太网帧的 Dst 里，就可以发出去了。后面就是正常的三次握手。收到 6 号 ACK 以后，服务器端的连接已经是 ESTABLISHED 状态。</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p3.png" alt="p3"></p>
<p>这个模拟我只有用 NAT 模式成功了，桥接模式下，第一步客户端通过 ARP 查询虚拟机 MAC 地址的时候，虚拟机ARP reply 的以太网帧的 Src MAC 居然是宿主机的 MAC，而 ARP 部分的 SRC 又是虚拟机自己的 MAC，大概是这种冲突导致第一个 SYN 报文的以太网帧的目的 MAC 没法正常填(会填成全 1 的广播 MAC，服务器直接丢弃了)，三次握手没法进行。暂时不知道为什么会这样，猜想是虚拟机桥接到物理机所使用的网卡了，在链路层封装以太网帧的时候填的都是同一个网卡的 MAC。</p>
<p>​	<strong>(2) 三次握手中的异常情况</strong></p>
<ul>
<li><p>第一次握手丢失</p>
<p>客户端超时重传 SYN 报文，重传次数由内核参数 tcp_syn_retries 决定，默认 5 次</p>
</li>
<li><p>第二次握手丢失</p>
<p>由于第二次握手既是服务器端的 SYN，又是对客户端第一次 SYN 的确认，所以若第二次丢失，客户端会超时重传它的 SYN，而由于服务器收不到确认，它也会重传第二次握手。服务器重传 SYN+ACK 报文次数由内核参数 tcp_synack_retries 决定，默认 5 次。</p>
</li>
<li><p>第三次握手丢失</p>
<p>发送第三次握手后，客户端单方面认为连接已建立。如果服务器没收到第三次握手，会重传第二次握手。我用 scapy 模拟了第三次握手丢失的情况，其实就不发第三个 ACK 就好了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">dst_ip = <span class="string">&quot;192.168.40.128&quot;</span></span><br><span class="line">dst_port = <span class="number">9999</span></span><br><span class="line">src_port = <span class="number">2222</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 SYN</span></span><br><span class="line">syn = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=RandInt(),flags=<span class="string">&quot;S&quot;</span>)</span><br><span class="line"><span class="comment"># 发送 SYN</span></span><br><span class="line">sr1(syn, verbose=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p4.png" alt="p4"></p>
<p>可见重传次数也是 5 次，且时间间隔为 1, 2, 4, 8, 16。服务器端连接状态变化如下，重传期间是 SYN_RECV 状态，最后一次重传也超时后，变为关闭状态。如果这时候又收到了迟到的 ACK 或者数据，服务器会回复一个 RST。</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p5.png" alt="p5"></p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p6.png" alt="p6"></p>
<p>总之，TCP 不会重传 ACK，ACK 也不需要被确认。可想而知如果 ACK 本身还需要确认和重传，那不就陷入了两将军问题的死循环了吗？所以发送 ACK 的一方总是假定对方能收到确认，如果 ACK 丢失，则由对方重传对应的报文。因为不需要被确认，所以 ACK 不消耗序列号，而 SYN，FIN 和数据都需要被确认，故它们要消耗序列号。</p>
</li>
</ul>
<h3 id="三、三次握手能否带数据"><a href="#三、三次握手能否带数据" class="headerlink" title="三、三次握手能否带数据"></a>三、三次握手能否带数据</h3><p>前两次不可以，第三次可以。因为前两次握手时双方的 ISN 都没达成共识，没法保证收发数据的正确性。第三次可以带数据是因为 ACK 本身就可以捎带，如果客户端收到第二次握手就直接发送数据，那这个数据报文就起到了第三次握手的确认作用。下面是验证：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data = <span class="string">&quot;Hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 SYN</span></span><br><span class="line">syn = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=RandInt(),flags=<span class="string">&quot;S&quot;</span>)</span><br><span class="line"><span class="comment"># 发送 SYN，接收服务器的 SYN + ACK</span></span><br><span class="line">syn_ack = sr1(syn, verbose=<span class="literal">False</span>)</span><br><span class="line">seq_num = syn_ack[TCP].ack</span><br><span class="line">ack_num = syn_ack[TCP].seq + <span class="number">1</span></span><br><span class="line"><span class="comment"># 直接发送数据</span></span><br><span class="line">data = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=seq_num,ack=ack_num,flags=<span class="string">&quot;A&quot;</span>)/data</span><br><span class="line">echo = sr1(data)</span><br><span class="line"><span class="built_in">print</span>(echo[TCP])</span><br></pre></td></tr></table></figure>

<p>可见握手正常完成，第三次握手夹带的数据也被正确地 echo 了。</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p7.png" alt="p7"></p>
<h3 id="四、TCP-三次握手是否存在两将军问题"><a href="#四、TCP-三次握手是否存在两将军问题" class="headerlink" title="四、TCP 三次握手是否存在两将军问题"></a>四、TCP 三次握手是否存在两将军问题</h3><p>​		三次握手不存在两将军问题，或者说存在，但几乎没啥影响。因为 TCP 三次握手的目的本来就是通信，它并不是像两将军问题那样要求达成共识后便不再通信的场景。三次握手虽然有可能在某一时刻出现双方不一致的状态，比如最后一次 ACK 丢失，客户端处于 ESTABLISHED 状态，服务器处于 SYN_RECV 状态，但这种不一致不会一直存在，比如这时候客户端发了一个数据报文段过来，那服务器自然就知道，哦，看来你已经收到我的 SYN 了，于是服务器也转变为 ESTABLISHED 状态，不一致就消除了。亦或者客户端一直没发送数据，那 TCP 的超时重传机制也会确保这种不一致不会一直存在，服务器重传 5 次 SYN 以后就会变成 CLOSED 状态，此后只要客户端试图发送数据，就会收到一个 RST，于是客户端就也变成 CLOSED 状态了。总之，三次握手中的不一致状态都可以通过后面的数据交互、超时重传机制来修复，自然就不存在两将军问题了。</p>
<h2 id="关于连接拆除"><a href="#关于连接拆除" class="headerlink" title="关于连接拆除"></a>关于连接拆除</h2><h3 id="一、四次挥手的手动模拟以及异常情况处理"><a href="#一、四次挥手的手动模拟以及异常情况处理" class="headerlink" title="一、四次挥手的手动模拟以及异常情况处理"></a>一、四次挥手的手动模拟以及异常情况处理</h3><p>​		<strong>(1) 正常四次挥手过程模拟</strong></p>
<p>​			正常四次挥手时序图：</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p8.jpg" alt="p8"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">dst_ip = <span class="string">&quot;192.168.40.128&quot;</span></span><br><span class="line">dst_port = <span class="number">9999</span></span><br><span class="line">src_port = <span class="number">2222</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 SYN</span></span><br><span class="line">syn = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=RandInt(),flags=<span class="string">&quot;S&quot;</span>)</span><br><span class="line"><span class="comment"># 发送 SYN，接收服务器的 SYN + ACK</span></span><br><span class="line">syn_ack = sr1(syn, verbose=<span class="literal">False</span>)</span><br><span class="line">seq_num = syn_ack[TCP].ack</span><br><span class="line">ack_num = syn_ack[TCP].seq + <span class="number">1</span></span><br><span class="line"><span class="comment"># 发送 ACK</span></span><br><span class="line">ack = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=seq_num,ack=ack_num,flags=<span class="string">&quot;A&quot;</span>)</span><br><span class="line">send(ack)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构造 FIN</span></span><br><span class="line">fin = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=seq_num,ack=ack_num,flags=<span class="string">&quot;FA&quot;</span>)</span><br><span class="line"><span class="comment"># 发送 FIN，等待服务器 ACK</span></span><br><span class="line">ack = sr1(fin)</span><br><span class="line">seq_num = ack[TCP].ack</span><br><span class="line">ack_num = ack[TCP].seq + <span class="number">1</span></span><br><span class="line"><span class="comment"># 发送 ACK</span></span><br><span class="line">ack = IP(dst=dst_ip)/TCP(dport=dst_port,sport=src_port,seq=seq_num,ack=ack_num,flags=<span class="string">&quot;A&quot;</span>)</span><br><span class="line">send(ack)</span><br></pre></td></tr></table></figure>

<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p9.png" alt="p9"></p>
<p>成功断开连接，但是可以发现是三次挥手，是因为 TCP server 在 read() 返回 0 之后立刻调用了 close()，所以 ACK 和 FIN 合成了一个包，像三次握手一样。但是在客户端半关闭的前提下，服务器端可以在收到客户端的 FIN 之后，先回复一个 ACK，然后继续发送数据，发完再 close()，这种情况下服务器的 ACK 和 FIN 之间还有数据报文段，所以一定是四次挥手。其实这里可以用打断点的方式强行把第二、三次挥手分开：</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p10.png" alt="p10"></p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p11.png" alt="p11"></p>
<p>在收到客户端 FIN，read() 返回 0 后断住，不让程序直接 close()。可以看到这次服务器的内核单独回复了一个 ACK。</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p12.png" alt="p12"></p>
<p>接下来让服务器执行 close():</p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p13.png" alt="p13"></p>
<p><img src="/pic/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/p14.png" alt="p14"></p>
<p>这样四次挥手就完整地分开了。</p>
<p>​	<strong>(2) 四次挥手异常情况处理</strong></p>
<p>​		这个情况有点复杂，实在懒得写了，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34827674/article/details/119809480">小林coding的这篇文章</a>，写得很全。</p>
<h3 id="二、四次挥手是否存在两将军问题"><a href="#二、四次挥手是否存在两将军问题" class="headerlink" title="二、四次挥手是否存在两将军问题"></a>二、四次挥手是否存在两将军问题</h3><p>​	四次挥手存在两将军问题，因为挥手的目的是说再见，之后不再通信，所以如果不能达成共识，会导致不一致一直存在。比如客户端最后一次 ACK 可能丢失，如果它单方面进入了 CLOSED 状态，那服务器还在 LAST_ACK 状态，会出现不一致。TCP 的弥补措施是添加了一段 TIME_WAIT 状态，结合超时重传机制，就是先不让客户端进入 CLOSED 状态，留一段时间来回复服务器的超时重传，等待对方和自己就连接断开达成共识。可以说是不完美但足够用的工程解。</p>
<p><strong>参考链接：</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/JulianHuang/p/16772563.html">两将军问题和三次握手</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/24853633/answer/200721662">TCP 为什么需要三次握手</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34827674/article/details/119809480">小林coding TCP 连接和断开异常情况总结</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/49679068/answer/117290667">ARP 在 TCP连接建立时的作用</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">Categories</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/JustDoIt0910">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">两将军问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B"><span class="toc-number">2.</span> <span class="toc-text">关于连接建立</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%EF%BC%8C%E4%B8%A4%E6%AC%A1%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%A1%8C"><span class="toc-number">2.1.</span> <span class="toc-text">一、为什么需要三次握手，两次为什么不行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E6%89%8B%E5%8A%A8%E6%A8%A1%E6%8B%9F%E4%BB%A5%E5%8F%8A%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">二、三次握手的手动模拟以及异常情况处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E8%83%BD%E5%90%A6%E5%B8%A6%E6%95%B0%E6%8D%AE"><span class="toc-number">2.3.</span> <span class="toc-text">三、三次握手能否带数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81TCP-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E4%B8%A4%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">四、TCP 三次握手是否存在两将军问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%BF%9E%E6%8E%A5%E6%8B%86%E9%99%A4"><span class="toc-number">3.</span> <span class="toc-text">关于连接拆除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E6%89%8B%E5%8A%A8%E6%A8%A1%E6%8B%9F%E4%BB%A5%E5%8F%8A%E5%BC%82%E5%B8%B8%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">一、四次挥手的手动模拟以及异常情况处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%E4%B8%A4%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98"><span class="toc-number">3.2.</span> <span class="toc-text">二、四次挥手是否存在两将军问题</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&text=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&is_video=false&description=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=对TCP三次握手和四次挥手的理解和探究&body=Check out this article: http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&title=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&name=对TCP三次握手和四次挥手的理解和探究&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/10/13/%E5%AF%B9TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E7%90%86%E8%A7%A3%E5%92%8C%E6%8E%A2%E7%A9%B6/&t=对TCP三次握手和四次挥手的理解和探究"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    ZR
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">Categories</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/JustDoIt0910">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
